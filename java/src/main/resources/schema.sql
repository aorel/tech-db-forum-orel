CREATE EXTENSION IF NOT EXISTS CITEXT;

CREATE TABLE IF NOT EXISTS users (
  id SERIAL NOT NULL PRIMARY KEY,
  nickname CITEXT NOT NULL UNIQUE,
  fullname CITEXT,
  email CITEXT NOT NULL UNIQUE,
  about TEXT);

CREATE TABLE IF NOT EXISTS forums (
  id SERIAL NOT NULL PRIMARY KEY,
  title CITEXT NOT NULL,
  user_id INT NOT NULL,
  slug CITEXT NOT NULL UNIQUE,
  FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS threads (
  id SERIAL NOT NULL PRIMARY KEY,
  title CITEXT NOT NULL,
  user_id INT NOT NULL,
  forum_id INT NOT NULL,
  message CITEXT NOT NULL,
  slug CITEXT UNIQUE,
  created TIMESTAMP DEFAULT NOW(),
  FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE ,
  FOREIGN KEY (forum_id) REFERENCES forums (id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS votes (
  id SERIAL NOT NULL PRIMARY KEY,
  user_id INT NOT NULL,
  thread_id INT NOT NULL,
  voice SMALLINT,
  FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE,
  FOREIGN KEY (thread_id) REFERENCES threads (id) ON DELETE CASCADE,
  UNIQUE (user_id, thread_id)
);

CREATE TABLE IF NOT EXISTS posts (
  id SERIAL NOT NULL PRIMARY KEY,
  parent_id INT DEFAULT 0,
  user_id INT NOT NULL,
  forum_id INT NOT NULL,
  thread_id INT NOT NULL,

  is_edited BOOLEAN DEFAULT FALSE,
  message CITEXT NOT NULL,
  created TIMESTAMP DEFAULT NOW(),

  FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE,
  FOREIGN KEY (forum_id) REFERENCES forums (id) ON DELETE CASCADE,
  FOREIGN KEY (thread_id) REFERENCES threads (id) ON DELETE CASCADE
);
